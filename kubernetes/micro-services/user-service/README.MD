# üßæ User Service ‚Äì Deployment on AWS EKS with Fargate

This repository contains the Kubernetes Helm chart and deployment configuration for the **User Service**, a FastAPI-based authentication microservice designed to run securely and scalably on **Amazon EKS with Fargate**.

---

## üß© Overview

The **User Service** handles:

* User registration and login
* JWT token issuance and validation
* Database interactions with **PostgreSQL on AWS RDS**
* Event publishing to the **Notification Service**
* Runtime credential access via **AWS Secrets Manager**
* Secure HTTPS ingress via **ACM-backed ALB**

---

## üîß Architecture

* **Kubernetes Platform**: Amazon EKS (1 cluster, Fargate profiles per microservice)
* **Networking**: Internal **ALB** + **Route 53**, private subnets only
* **Database**: PostgreSQL (provisioned via AWS RDS)
* **Secrets**: Managed via AWS Secrets Manager
* **Image Registry**: Amazon ECR (`mallhive-user-service`)
* **Ingress Security**: HTTPS with **ACM certificate**, internal DNS via `user.internal.mallhive.com`
* **Namespace**: `user-service` (with its own Fargate profile)
* **Service Communication**: Across microservices using DNS (`service-name.namespace.svc.cluster.local`) + `NetworkPolicy`

---

## üìÅ Folder Structure

```
user-service/
‚îú‚îÄ‚îÄ helm/
‚îÇ   ‚îú‚îÄ‚îÄ Chart.yaml
‚îÇ   ‚îú‚îÄ‚îÄ values.yaml
‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ       ‚îú‚îÄ‚îÄ configmap.yaml
‚îÇ       ‚îú‚îÄ‚îÄ deployment.yaml
‚îÇ       ‚îú‚îÄ‚îÄ hpa.yaml
‚îÇ       ‚îú‚îÄ‚îÄ ingress.yaml
‚îÇ       ‚îú‚îÄ‚îÄ service.yaml
‚îÇ       ‚îú‚îÄ‚îÄ serviceaccount.yaml
‚îÇ       ‚îú‚îÄ‚îÄ networkpolicy.yaml
‚îÇ       ‚îú‚îÄ‚îÄ namespace.yaml
‚îú‚îÄ‚îÄ README.md
```

---

## üîê Secrets & IAM (IRSA)

This service **does not store any secrets in Kubernetes**. All secrets (like DB creds, JWT secret) are fetched at runtime using `boto3` from **Secrets Manager**, using **IAM Role for Service Account (IRSA)**.

### IAM Permissions

```json
{
  "Effect": "Allow",
  "Action": [
    "secretsmanager:GetSecretValue"
  ],
  "Resource": "arn:aws:secretsmanager:us-east-1:123456789012:secret:user-service/*"
}
```

## üì¶ Deployment via Helm

```bash
helm upgrade --install user-service ./helm \
  --namespace user-service \
  --create-namespace
```

> This assumes:
>
> * You have IRSA and Fargate profile created for `user-service`
> * The ECR image is pushed
> * Your ACM cert + Route 53 entries are valid

---

## üìä Monitoring & Observability

| Layer                | Tooling                                        |
| -------------------- | ---------------------------------------------- |
| EKS Control Plane    | CloudTrail, CloudWatch Logs                    |
| Fargate Metrics      | CloudWatch Container Insights                  |
| Pod Health & Metrics | Prometheus + AlertManager                      |
| Logs                 | CloudWatch or third-party logging like Datadog |
| App Tracing (opt)    | OpenTelemetry or X-Ray                         |

---

## ‚úÖ Requirements

* ‚úÖ EKS cluster w/ Fargate enabled
* ‚úÖ IRSA-enabled `ServiceAccount` and IAM role
* ‚úÖ RDS PostgreSQL instance in same VPC
* ‚úÖ ALB Ingress Controller and valid ACM cert
* ‚úÖ DNS record in Route 53
* ‚úÖ Helm installed and configured with kubeconfig
* ‚úÖ ECR image pushed (`mallhive-user-service`)

---

## üîê Inter-Service Communication (within cluster)

Services talk to each other using Kubernetes DNS:

```
http://notification-service.notification.svc.cluster.local
```

To allow cross-namespace traffic securely:

* Use `NetworkPolicy` with `namespaceSelector` + `podSelector`
* Or use a service mesh (if planning for mTLS)

---

